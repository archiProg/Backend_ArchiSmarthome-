<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Set New Password</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #fff 0%, #eee 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 420px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      .password-wrapper {
        position: relative;
      }

      input[type="password"],
      input[type="text"] {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.3s;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
      }

      .toggle-password {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
        font-size: 20px;
        padding: 0;
        width: 24px;
        height: 24px;
      }

      .toggle-password:hover {
        color: #667eea;
      }

      .password-strength {
        margin-top: 8px;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
      }

      .strength-bar {
        height: 100%;
        width: 0;
        transition: width 0.3s, background-color 0.3s;
      }

      .strength-bar.weak {
        width: 33%;
        background: #f44336;
      }

      .strength-bar.medium {
        width: 66%;
        background: #ff9800;
      }

      .strength-bar.strong {
        width: 100%;
        background: #4caf50;
      }

      .strength-text {
        font-size: 12px;
        margin-top: 4px;
        color: #666;
      }

      .requirements {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .requirements h3 {
        font-size: 13px;
        color: #333;
        margin-bottom: 10px;
      }

      .requirement {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        padding-left: 20px;
        position: relative;
      }

      .requirement::before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #ccc;
      }

      .requirement.met::before {
        color: #4caf50;
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        color: #f44336;
        font-size: 13px;
        margin-top: 5px;
        display: none;
      }

      .success-message {
        background: #4caf50;
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        display: none;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Set New Password</h1>
      <p class="subtitle">Choose a strong password to secure your account</p>

      <div class="input-group">
        <label for="newPassword">New Password</label>
        <div class="password-wrapper">
          <input
            type="password"
            id="newPassword"
            placeholder="Enter new password"
          />
          <button
            type="button"
            class="toggle-password"
            onclick="togglePassword('newPassword', this)"
          >
            üëÅÔ∏è
          </button>
        </div>
        <div class="password-strength">
          <div class="strength-bar" id="strengthBar"></div>
        </div>
        <div class="strength-text" id="strengthText"></div>
      </div>

      <div class="input-group">
        <label for="confirmPassword">Confirm Password</label>
        <div class="password-wrapper">
          <input
            type="password"
            id="confirmPassword"
            placeholder="Re-enter password"
          />
          <button
            type="button"
            class="toggle-password"
            onclick="togglePassword('confirmPassword', this)"
          >
            üëÅÔ∏è
          </button>
        </div>
        <div class="error-message" id="matchError">Passwords do not match</div>
      </div>

      <div class="requirements">
        <h3>Password Requirements:</h3>
        <div class="requirement" id="req-length">At least 8 characters</div>
        <div class="requirement" id="req-uppercase">One uppercase letter</div>
        <div class="requirement" id="req-lowercase">One lowercase letter</div>
        <div class="requirement" id="req-number">One number</div>
        <div class="requirement" id="req-special">One special character</div>
      </div>

      <button class="btn" onclick="submitPassword()">Set New Password</button>

      <div class="success-message" id="successMessage">
        ‚úì Password successfully updated!
      </div>
    </div>

    <script>
      const newPasswordInput = document.getElementById("newPassword");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const strengthBar = document.getElementById("strengthBar");
      const strengthText = document.getElementById("strengthText");
      const matchError = document.getElementById("matchError");

      newPasswordInput.addEventListener("input", checkPasswordStrength);
      confirmPasswordInput.addEventListener("input", checkPasswordMatch);

      function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
          input.type = "text";
          button.textContent = "üôà";
        } else {
          input.type = "password";
          button.textContent = "üëÅÔ∏è";
        }
      }

      function checkPasswordStrength() {
        const password = newPasswordInput.value;
        let strength = 0;

        const requirements = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[^A-Za-z0-9]/.test(password),
        };

        document
          .getElementById("req-length")
          .classList.toggle("met", requirements.length);
        document
          .getElementById("req-uppercase")
          .classList.toggle("met", requirements.uppercase);
        document
          .getElementById("req-lowercase")
          .classList.toggle("met", requirements.lowercase);
        document
          .getElementById("req-number")
          .classList.toggle("met", requirements.number);
        document
          .getElementById("req-special")
          .classList.toggle("met", requirements.special);

        strength = Object.values(requirements).filter(Boolean).length;

        strengthBar.className = "strength-bar";
        if (strength <= 2) {
          strengthBar.classList.add("weak");
          strengthText.textContent = "Weak password";
          strengthText.style.color = "#f44336";
        } else if (strength <= 4) {
          strengthBar.classList.add("medium");
          strengthText.textContent = "Medium password";
          strengthText.style.color = "#ff9800";
        } else {
          strengthBar.classList.add("strong");
          strengthText.textContent = "Strong password";
          strengthText.style.color = "#4caf50";
        }
      }

      function checkPasswordMatch() {
        if (
          confirmPasswordInput.value &&
          newPasswordInput.value !== confirmPasswordInput.value
        ) {
          matchError.style.display = "block";
        } else {
          matchError.style.display = "none";
        }
      }

      async function submitPassword() {
        const queryString = window.location.search; // Returns "?id=123&category=electronics&tag=sale"
        const urlParams = new URLSearchParams(queryString);

        const token = urlParams.get("token"); // "electronics"
        const password = newPasswordInput.value;
        const confirm = confirmPasswordInput.value;

        const requirements = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[^A-Za-z0-9]/.test(password),
        };

        const allMet = Object.values(requirements).every(Boolean);

        if (!allMet) {
          alert("Please meet all password requirements");
          return;
        }

        if (password !== confirm) {
          matchError.style.display = "block";
          return;
        }

        document.getElementById("successMessage").style.display = "block";
        try {
          // Change this path to match your backend endpoint:
          const endpoint = "/app/setnewpassword"; // <-- backend should accept { token, password }
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: token, password: password }),
          });

          if (!res.ok) {
             // const body = await res
            //   .json()
            //   .catch(() => ({ message: "Server error" }));
            // errorBox.textContent =
            //   body.message || "Failed to update password (" + res.status + ")";
            // show(errorBox);
            // submitBtn.disabled = false;
            // submitBtn.textContent = "Set password";
            return;
          }

          // success
          alert(
            "Your password was updated. You will be redirected to the login page."
          );
          // window.location.href = "/login.html";
        } catch (err) {
          console.error(err);
          // errorBox.textContent = "Network error. Please try again.";
          // show(errorBox);
          // submitBtn.disabled = false;
          // submitBtn.textContent = "Set password";
        }
      }
    </script>
  </body>
</html>
